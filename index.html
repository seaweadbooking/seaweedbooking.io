<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Seaweed Booking</title>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
body { font-family: Arial; background:#e6f7f4; padding:30px; text-align:center; }
.box { background:white; max-width:600px; margin:auto; padding:25px; border-radius:10px; }
input,button { width:95%; padding:12px; margin:6px 0; font-size:16px; }
button { background:#0a5c5a; color:white; border:none; border-radius:6px; }
.hidden { display:none; }
table { width:100%; border-collapse:collapse; margin-top:15px; }
th,td { border:1px solid #0a5c5a; padding:8px; }
th { background:#0a5c5a; color:white; }
</style>
</head>

<body>

<div id="authBox" class="box">
<h2>Sign Up</h2>
<input id="name" placeholder="Name">
<input id="password" type="password" placeholder="Password">
<button onclick="signup()">Sign Up</button>

<hr>

<h2>Login</h2>
<input id="loginName" placeholder="Name">
<input id="loginPassword" type="password" placeholder="Password">
<button onclick="login()">Login</button>
</div>

<div id="site" class="box hidden">
<h2>Seaweed Booking</h2>
<p id="welcome"></p>

<h3>Tuesday</h3>
<table>
<tr><th>#</th><th>Name</th></tr>
<tbody id="tuesdayTable"></tbody>
</table>
<button onclick="book('Tuesday')">Book Tuesday</button>

<h3>Thursday</h3>
<table>
<tr><th>#</th><th>Name</th></tr>
<tbody id="thursdayTable"></tbody>
</table>
<button onclick="book('Thursday')">Book Thursday</button>

<p id="message"></p>
<button onclick="logout()">Logout</button>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyA4txYmTD_fOvcMBmwZxWJfGn4TZFMZARM",
  authDomain: "fir-969c9.firebaseapp.com",
  projectId: "fir-969c9"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const MAX_SLOTS = 8;
let currentUser = null;

// Convert name â†’ hidden email
function makeEmail(name) {
  return name.toLowerCase().replace(/\s+/g,"") + "@seaweed.local";
}

// SIGN UP
function signup() {
  const name = document.getElementById("name").value.trim();
  const password = document.getElementById("password").value;
  if (!name || !password) return alert("Fill all fields");

  const email = makeEmail(name);

  auth.createUserWithEmailAndPassword(email, password)
    .then(res => res.user.updateProfile({ displayName: name }))
    .catch(err => alert(err.message));
}

// LOGIN
function login() {
  const name = document.getElementById("loginName").value.trim();
  const password = document.getElementById("loginPassword").value;
  if (!name || !password) return alert("Fill all fields");

  auth.signInWithEmailAndPassword(makeEmail(name), password)
    .catch(err => alert("Wrong name or password"));
}

function logout() {
  auth.signOut();
}

// AUTH STATE
auth.onAuthStateChanged(user => {
  if (user) {
    currentUser = user;
    authBox.classList.add("hidden");
    site.classList.remove("hidden");
    welcome.innerText = "Welcome, " + user.displayName;
    loadDay("Tuesday","tuesdayTable");
    loadDay("Thursday","thursdayTable");
  } else {
    authBox.classList.remove("hidden");
    site.classList.add("hidden");
  }
});

// BOOKINGS
function loadDay(day, tableId) {
  db.collection("bookings")
    .where("day","==",day)
    .orderBy("time","asc")
    .onSnapshot(snapshot => {
      const table = document.getElementById(tableId);
      table.innerHTML = "";
      snapshot.forEach((doc,i) => {
        table.innerHTML += `<tr><td>${i+1}</td><td>${doc.data().name}</td></tr>`;
      });
    });
}

function book(day) {
  db.collection("bookings")
    .where("day","==",day)
    .get()
    .then(snap => {
      if (snap.size >= MAX_SLOTS) return alert(day+" full");

      db.collection("bookings").add({
        day,
        name: currentUser.displayName,
        time: firebase.firestore.FieldValue.serverTimestamp()
      });
    });
}
</script>
</body>
</html>
